//go:build run
// +build run

package main

import (
	"bytes"
	"context"
	"fmt"
	"io"
	"os"
	"time"

	"github.com/spiegel-im-spiegel/cov19data/filter"
	"github.com/spiegel-im-spiegel/cov19data/tokyo"
	"github.com/spiegel-im-spiegel/cov19data/tokyo/entity"
	"github.com/spiegel-im-spiegel/cov19data/values"
	"github.com/spiegel-im-spiegel/errs"
	"github.com/spiegel-im-spiegel/fetch"
)

func getData() ([]*entity.TokyoData, error) {
	impt, err := tokyo.NewWeb(context.Background(), fetch.New())
	if err != nil {
		return nil, errs.Wrap(err)
	}
	defer impt.Close()
	return impt.Data(
		filter.WithPeriod(
			values.NewPeriod(
				values.NewDate(2020, time.Month(9), 28),
				values.NewDate(2020, time.Month(9), 28),
			),
		),
	)
}

func main() {
	data, err := getData()
	if err != nil {
		fmt.Printf("%+v\n", err)
		return
	}
	b, err := entity.ExportCSV(data)
	if err != nil {
		fmt.Printf("%+v\n", err)
		return
	}

	if _, err := io.Copy(os.Stdout, bytes.NewReader(b)); err != nil {
		fmt.Println()
	}
	// Output:
	// 発生日付,地方公共団体コード,対象者の居住地,対象者の年代,対象者の性別,退院フラグ
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,30代,女性,
	// 2020-09-28,130001,,90代,女性,
	// 2020-09-28,130001,,60代,女性,
	// 2020-09-28,130001,,40代,男性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,30代,男性,
	// 2020-09-28,130001,,10歳未満,女性,
	// 2020-09-28,130001,,30代,男性,
	// 2020-09-28,130001,,50代,女性,
	// 2020-09-28,130001,,50代,女性,
	// 2020-09-28,130001,,40代,男性,
	// 2020-09-28,130001,,50代,男性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,30代,男性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,60代,男性,
	// 2020-09-28,130001,,10代,女性,
	// 2020-09-28,130001,,60代,女性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,30代,女性,
	// 2020-09-28,130001,,40代,男性,
	// 2020-09-28,130001,,70代,男性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,40代,男性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,50代,男性,
	// 2020-09-28,130001,,30代,女性,
	// 2020-09-28,130001,,30代,女性,
	// 2020-09-28,130001,,40代,女性,
	// 2020-09-28,130001,,50代,男性,
	// 2020-09-28,130001,,40代,男性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,40代,男性,
	// 2020-09-28,130001,,10代,男性,
	// 2020-09-28,130001,,70代,女性,
	// 2020-09-28,130001,,50代,男性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,30代,男性,
	// 2020-09-28,130001,,40代,女性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,50代,女性,
	// 2020-09-28,130001,,30代,女性,
	// 2020-09-28,130001,,30代,男性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,30代,男性,
	// 2020-09-28,130001,,90代,女性,
	// 2020-09-28,130001,,80代,男性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,30代,女性,
	// 2020-09-28,130001,,30代,女性,
	// 2020-09-28,130001,,40代,男性,
	// 2020-09-28,130001,,40代,男性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,40代,男性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,30代,女性,
	// 2020-09-28,130001,,40代,女性,
	// 2020-09-28,130001,,50代,男性,
	// 2020-09-28,130001,,20代,女性,
	// 2020-09-28,130001,,40代,女性,
	// 2020-09-28,130001,,80代,男性,
	// 2020-09-28,130001,,30代,男性,
	// 2020-09-28,130001,,90代,女性,
	// 2020-09-28,130001,,50代,女性,
	// 2020-09-28,130001,,20代,男性,
	// 2020-09-28,130001,,80代,男性,
	// 2020-09-28,130001,,60代,女性,
}
